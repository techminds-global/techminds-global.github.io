// Customer Portal JavaScript

// Set base API URL
const BASE_URL = 'https://localhost:7001/api';

document.addEventListener('DOMContentLoaded', function () {
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('date-input');
    if (dateInput) {
        dateInput.value = today;
    }

    // Modal functionality
    const modal = document.getElementById('authModal');
    const profileToggle = document.getElementById('profile-toggle');
    const closeModal = document.getElementById('closeModal');
    const loginTab = document.getElementById('loginTab');
    const signupTab = document.getElementById('signupTab');
    const loginForm = document.getElementById('loginForm');
    const signupForm = document.getElementById('signupForm');

    const searchToggle = document.getElementById('search-toggle');
    const searchContainer = document.querySelector('.search-container');

    // Show modal when profile is clicked
    if (profileToggle) {
        profileToggle.addEventListener('click', function (e) {
            e.preventDefault();
            modal.style.display = 'block';
        });
    }

    // Close modal
    if (closeModal) {
        closeModal.addEventListener('click', function () {
            modal.style.display = 'none';
        });
    }

    // Close modal when clicking outside
    window.addEventListener('click', function (e) {
        if (e.target === modal) {
            modal.style.display = 'none';
        }
    });

    // Tab switching
    if (loginTab && signupTab) {
        loginTab.addEventListener('click', function () {
            loginTab.classList.add('active');
            signupTab.classList.remove('active');
            loginForm.classList.add('active');
            signupForm.classList.remove('active');
        });

        signupTab.addEventListener('click', function () {
            signupTab.classList.add('active');
            loginTab.classList.remove('active');
            signupForm.classList.add('active');
            loginForm.classList.remove('active');
        });
    }

    // Login form submission
    if (loginForm) {
        loginForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            // Show loading state
            const submitBtn = loginForm.querySelector('.modal-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Logging in...';
            submitBtn.disabled = true;

            // Make API call
            fetch(`${BASE_URL}/auth/login`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    email: email,
                    password: password
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Store token and user info
                        localStorage.setItem('customerToken', data.token);
                        localStorage.setItem('customerUser', JSON.stringify(data.user));

                        showNotification('Login successful!', 'success');

                        // Redirect to profile page
                        setTimeout(() => {
                            window.location.href = '/Home/Profile';
                        }, 1000);
                    } else {
                        showNotification(data.message || 'Login failed', 'error');
                    }
                })
                .catch(error => {
                    console.error('Login error:', error);
                    showNotification('Login failed. Please try again.', 'error');
                })
                .finally(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
        });
    }

    // Signup form submission
    if (signupForm) {
        signupForm.addEventListener('submit', function (e) {
            e.preventDefault();

            const firstName = document.getElementById('signupFirstName').value;
            const lastName = document.getElementById('signupLastName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('signupConfirmPassword').value;
            const wantsToOfferRide = document.getElementById('signupWantsToOfferRide').checked;

            if (!firstName || !lastName || !email || !password) {
                showNotification('Please fill in all fields', 'error');
                return;
            }

            // Show loading state
            const submitBtn = signupForm.querySelector('.modal-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating account...';
            submitBtn.disabled = true;

            // Make API call
            fetch(`${BASE_URL}/auth/register`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    firstName: firstName,
                    lastName: lastName,
                    email: email,
                    password: password,
                    confirmPassword: confirmPassword,
                    wantsToOfferRide: wantsToOfferRide,
                    role: 'Customer'
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Store token and user info
                        localStorage.setItem('customerToken', data.token);
                        localStorage.setItem('customerUser', JSON.stringify(data.user));

                        showNotification('Account created successfully!', 'success');

                        // Redirect to profile page
                        setTimeout(() => {
                            window.location.href = '/Home/Profile';
                        }, 1000);
                    } else {
                        showNotification(data.message || 'Registration failed', 'error');
                    }
                })
                .catch(error => {
                    console.error('Registration error:', error);
                    showNotification('Registration failed. Please try again.', 'error');
                })
                .finally(() => {
                    submitBtn.textContent = originalText;
                    submitBtn.disabled = false;
                });
        });
    }

    if (searchToggle && searchContainer) {
        searchToggle.addEventListener('click', function (e) {
            e.preventDefault();
            searchContainer.classList.toggle('show-search');
        });
    }

    // Scroll to top functionality
    const scrollBtn = document.querySelector('.scroll-top');

    if (scrollBtn) {
        window.addEventListener('scroll', () => {
            if (window.pageYOffset > 300) {
                scrollBtn.classList.add('visible');
            } else {
                scrollBtn.classList.remove('visible');
            }
        });

        scrollBtn.addEventListener('click', () => {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        });
    }

    // Search functionality
    const searchBtn = document.querySelector('.search-btn');
    const fromInput = document.getElementById('from-input');
    const toInput = document.getElementById('to-input');

    if (searchBtn && fromInput && toInput) {
        searchBtn.addEventListener('click', function () {
            if (!fromInput.value || !toInput.value) {
                showNotification('Please enter both departure and destination locations', 'error');
            } else {
                showNotification('Searching for eco-friendly rides...', 'info');

                // Simulate search process
                setTimeout(() => {
                    showNotification('Found 12 eco-friendly rides matching your criteria!', 'success');
                }, 2000);
            }
        });
    }

    // Footer profile toggle
    const footerProfileToggle = document.getElementById('footer-profile-toggle');
    if (footerProfileToggle) {
        footerProfileToggle.addEventListener('click', (e) => {
            e.preventDefault();
            modal.style.display = 'block';
        });
    }

    // Footer search toggle
    const footerSearchToggle = document.getElementById('footer-search-toggle');
    if (footerSearchToggle) {
        footerSearchToggle.addEventListener('click', (e) => {
            e.preventDefault();
            // Scroll to search section
            const searchContainer = document.querySelector('.search-container');
            if (searchContainer) {
                searchContainer.scrollIntoView({
                    behavior: 'smooth'
                });
            }
        });
    }
});

// Notification function
function showNotification(message, type = 'info') {
    // Remove existing notifications
    const existingNotifications = document.querySelectorAll('.notification');
    existingNotifications.forEach(notification => notification.remove());

    // Create notification element
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <span>${message}</span>
            <button class="notification-close">&times;</button>
        </div>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Show notification
    setTimeout(() => {
        notification.classList.add('show');
    }, 100);

    // Close button functionality
    const closeBtn = notification.querySelector('.notification-close');
    if (closeBtn) {
        closeBtn.addEventListener('click', () => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 300);
        });
    }

    // Auto hide after 5 seconds
    setTimeout(() => {
        if (notification.parentNode) {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 300);
        }
    }, 5000);
}

// Add animation styles
const style = document.createElement('style');
style.textContent = `
    .notification-content {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
    }
    .notification-close {
        background: none;
        border: none;
        color: white;
        font-size: 18px;
        cursor: pointer;
        padding: 0;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .notification-close:hover { 
        opacity: 0.8; 
    }
`;
document.head.appendChild(style);

// Logout function
function logout() {
    // Clear localStorage
    localStorage.removeItem('customerToken');
    localStorage.removeItem('customerUser');
    
    // Redirect to home page
    window.location.href = '/';
} 
